<div class="modal-overlay" (click)="onOverlayClick($event)">
  <div class="modal-box">

    <!-- Header -->
    <div class="modal-header">
      <div class="modal-header-left">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1f5b45" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <h2 class="modal-title">
          <span *ngIf="!selected">Service Requests</span>
          <span *ngIf="selected">Request Details</span>
        </h2>
      </div>
      <button class="modal-close" (click)="close()" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- ── LIST VIEW ── -->
    <div *ngIf="!selected">

      <!-- Summary pills -->
      <div *ngIf="!loading && requests.length > 0" class="summary-pills">
        <div class="pill pill--purple">
          <span>{{ ongoing }}</span> Ongoing
        </div>
        <div class="pill pill--green">
          <span>{{ completed }}</span> Completed
        </div>
        <div class="pill pill--red">
          <span>{{ cancelled }}</span> Cancelled
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="center-state">
        <div class="spinner"></div>
      </div>

      <!-- Error -->
      <div *ngIf="!loading && error" class="error-msg mx">{{ error }}</div>

      <!-- Empty -->
      <div *ngIf="!loading && !error && requests.length === 0" class="empty-state">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#bcc4c1" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <p>No service requests found.</p>
      </div>

      <!-- Request list -->
      <div *ngIf="!loading && !error && requests.length > 0" class="list-body">
        <div
          *ngFor="let req of requests"
          class="list-item"
          (click)="openDetail(req)"
        >
          <div class="item-left">
            <div class="item-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1f5b45" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
            </div>
            <div class="item-info">
              <div class="item-row-top">
                <span class="item-ref">{{ req.serviceRequestRef }}</span>
                <span class="status-badge" [ngClass]="getStatusClass(req.status)">{{ req.status }}</span>
              </div>
              <p class="item-type">{{ req.serviceType === 'Other' ? req.serviceTypeOther || 'Other' : req.serviceType }}</p>
              <p class="item-meta">{{ req.acUnitModel || 'AC unit not specified' }} &nbsp;·&nbsp; {{ formatDate(req.createdAt) }}</p>
            </div>
          </div>
          <svg class="item-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- ── DETAIL VIEW ── -->
    <div *ngIf="selected" class="detail-body">
      <button class="back-btn" (click)="backToList()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Back to list
      </button>

      <!-- Ref + status row -->
      <div class="detail-ref-row">
        <div>
          <p class="detail-ref">{{ selected.serviceRequestRef }}</p>
          <p class="detail-date">Submitted {{ formatDate(selected.createdAt) }}</p>
        </div>
        <span class="status-badge" [ngClass]="getStatusClass(selected.status)">{{ selected.status }}</span>
      </div>

      <!-- Status progress bar -->
      <div class="progress-track">
        <div
          *ngFor="let s of ['Pending','Assigned','In Progress','Completed']"
          class="progress-step"
          [ngClass]="{
            'pstep--active': selected.status === s,
            'pstep--done': isStepDone(s, selected.status),
            'pstep--cancelled': selected.status === 'Cancelled'
          }"
        >
          <div class="pstep-dot"></div>
          <span class="pstep-label">{{ s }}</span>
        </div>
      </div>

      <!-- Detail grid -->
      <div class="detail-grid">
        <div class="detail-row">
          <span class="d-label">Service Type</span>
          <span class="d-value">{{ selected.serviceType === 'Other' ? selected.serviceTypeOther || 'Other' : selected.serviceType }}</span>
        </div>
        <div class="detail-row" *ngIf="selected.acUnitModel">
          <span class="d-label">AC Model</span>
          <span class="d-value">{{ selected.acUnitModel }}</span>
        </div>
        <div class="detail-row" *ngIf="selected.acUnitSerial">
          <span class="d-label">Serial No.</span>
          <span class="d-value mono">{{ selected.acUnitSerial }}</span>
        </div>
        <div class="detail-row">
          <span class="d-label">Warranty</span>
          <span class="status-badge" [ngClass]="selected.acWarrantyStatus === 'Active' ? 'badge--green' : 'badge--grey'">
            {{ selected.acWarrantyStatus }}
          </span>
        </div>
        <div class="detail-row">
          <span class="d-label">AMC</span>
          <span class="status-badge" [ngClass]="selected.acAmcStatus === 'Active' ? 'badge--green' : 'badge--grey'">
            {{ selected.acAmcStatus }}
          </span>
        </div>
        <div class="detail-row" *ngIf="selected.preferredDate">
          <span class="d-label">Preferred Date</span>
          <span class="d-value">{{ formatDate(selected.preferredDate) }}</span>
        </div>
        <div class="detail-row" *ngIf="selected.preferredTimeSlot">
          <span class="d-label">Time Slot</span>
          <span class="d-value">{{ selected.preferredTimeSlot }}</span>
        </div>
        <div class="detail-row">
          <span class="d-label">Est. Charges</span>
          <span class="d-value" [ngClass]="selected.estimatedCharges === 0 ? 'text-green' : ''">
            {{ formatAmount(selected.estimatedCharges) }}
          </span>
        </div>
        <div class="detail-row detail-row--full" *ngIf="selected.problemDescription">
          <span class="d-label">Problem Description</span>
          <p class="d-value d-desc">{{ selected.problemDescription }}</p>
        </div>
      </div>

      <div *ngIf="cancelError" class="error-msg">{{ cancelError }}</div>

      <!-- Actions -->
      <div *ngIf="canCancel(selected)" class="action-row">
        <button class="btn-danger" (click)="cancelRequest(selected)" [disabled]="cancelling">
          <span *ngIf="cancelling" class="btn-spinner"></span>
          <span>{{ cancelling ? 'Cancelling...' : 'Cancel Request' }}</span>
        </button>
        <a href="mailto:support@airlux.com" class="btn-ghost">Contact Support</a>
      </div>
    </div>

  </div>
</div>
