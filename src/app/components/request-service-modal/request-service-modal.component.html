<div class="modal-overlay" (click)="onOverlayClick($event)">
  <div class="modal-box">

    <!-- Header -->
    <div class="modal-header">
      <div class="modal-header-left">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1f5b45" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <h2 class="modal-title">Request Service</h2>
      </div>
      <button class="modal-close" (click)="close()" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Success Screen -->
    <div *ngIf="submitted" class="success-screen">
      <div class="success-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h3 class="success-title">Request Submitted!</h3>
      <p class="success-msg">Your service request has been received. Our team will contact you shortly.</p>
      <div class="ref-box">
        <span class="ref-label">Service Request ID</span>
        <span class="ref-value">{{ submittedRef }}</span>
      </div>
      <div class="success-status-row">
        <span class="success-status-label">Status</span>
        <span class="status-badge badge--purple">Pending</span>
      </div>
      <button class="btn-primary" (click)="close()">Done</button>
    </div>

    <!-- Stepper UI -->
    <div *ngIf="!submitted">
      <!-- Step Indicators -->
      <div class="stepper">
        <div class="step-item" [ngClass]="{'step-active': step === 1, 'step-done': step > 1}">
          <div class="step-circle">
            <svg *ngIf="step > 1" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span *ngIf="step <= 1">1</span>
          </div>
          <span class="step-label">AC Unit</span>
        </div>
        <div class="step-connector" [ngClass]="{'connector-done': step > 1}"></div>
        <div class="step-item" [ngClass]="{'step-active': step === 2, 'step-done': step > 2}">
          <div class="step-circle">
            <svg *ngIf="step > 2" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span *ngIf="step <= 2">2</span>
          </div>
          <span class="step-label">Service</span>
        </div>
        <div class="step-connector" [ngClass]="{'connector-done': step > 2}"></div>
        <div class="step-item" [ngClass]="{'step-active': step === 3}">
          <div class="step-circle"><span>3</span></div>
          <span class="step-label">Summary</span>
        </div>
      </div>

      <!-- STEP 1: AC Unit -->
      <div *ngIf="step === 1" class="step-body">
        <p class="step-desc">Enter your AC unit details for warranty and AMC validation.</p>

        <div class="form-group">
          <label class="form-label">AC Model</label>
          <input class="form-input" type="text" placeholder="e.g. AirLux Pro 2.0 Ton" [(ngModel)]="acUnitModel" />
        </div>

        <div class="form-group">
          <label class="form-label">Serial Number</label>
          <input class="form-input" type="text" placeholder="e.g. SN-20231104-XY" [(ngModel)]="acUnitSerial" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Warranty Status</label>
            <select class="form-input" [(ngModel)]="acWarrantyStatus">
              <option value="Unknown">Unknown</option>
              <option value="Active">Active</option>
              <option value="Expired">Expired</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">AMC Status</label>
            <select class="form-input" [(ngModel)]="acAmcStatus">
              <option value="Not Active">Not Active</option>
              <option value="Active">Active</option>
            </select>
          </div>
        </div>

        <!-- Validation banner -->
        <div class="coverage-banner" [ngClass]="isFreeService ? 'banner--green' : 'banner--orange'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" [attr.stroke]="isFreeService ? '#1f5b45' : '#b45309'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span *ngIf="isFreeService">Service is covered — <strong>Free of charge</strong> (Warranty or AMC active)</span>
          <span *ngIf="!isFreeService">Warranty/AMC not active — <strong>Service charges apply</strong></span>
        </div>

        <div class="step-footer">
          <span></span>
          <button class="btn-primary" (click)="nextStep()">Continue</button>
        </div>
      </div>

      <!-- STEP 2: Service Details -->
      <div *ngIf="step === 2" class="step-body">
        <div class="form-group">
          <label class="form-label">Service Type <span class="required">*</span></label>
          <div class="service-type-grid">
            <button
              *ngFor="let type of serviceTypes"
              class="type-chip"
              [ngClass]="{'type-chip--active': serviceType === type}"
              (click)="serviceType = type; error = null"
            >
              {{ type }}
            </button>
          </div>
        </div>

        <div *ngIf="serviceType === 'Other'" class="form-group">
          <label class="form-label">Please specify</label>
          <input class="form-input" type="text" placeholder="Describe the service needed" [(ngModel)]="serviceTypeOther" />
        </div>

        <div class="form-group">
          <label class="form-label">Problem Description</label>
          <textarea class="form-textarea" rows="3" placeholder="Describe the issue in detail..." [(ngModel)]="problemDescription"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Preferred Date</label>
            <input class="form-input" type="date" [min]="minDate" [(ngModel)]="preferredDate" />
          </div>
          <div class="form-group">
            <label class="form-label">Time Slot</label>
            <select class="form-input" [(ngModel)]="preferredTimeSlot">
              <option value="">Select a slot</option>
              <option *ngFor="let slot of timeSlots" [value]="slot">{{ slot }}</option>
            </select>
          </div>
        </div>

        <div *ngIf="error" class="error-msg">{{ error }}</div>

        <div class="step-footer">
          <button class="btn-ghost" (click)="prevStep()">Back</button>
          <button class="btn-primary" (click)="nextStep()">Review</button>
        </div>
      </div>

      <!-- STEP 3: Summary -->
      <div *ngIf="step === 3" class="step-body">
        <h3 class="summary-heading">Review your request</h3>

        <div class="summary-grid">
          <div class="summary-row">
            <span class="meta-label">AC Model</span>
            <span class="meta-value">{{ acUnitModel || '—' }}</span>
          </div>
          <div class="summary-row">
            <span class="meta-label">Serial Number</span>
            <span class="meta-value mono">{{ acUnitSerial || '—' }}</span>
          </div>
          <div class="summary-row">
            <span class="meta-label">Warranty</span>
            <span class="status-badge" [ngClass]="acWarrantyStatus === 'Active' ? 'badge--green' : 'badge--grey'">
              {{ acWarrantyStatus }}
            </span>
          </div>
          <div class="summary-row">
            <span class="meta-label">AMC</span>
            <span class="status-badge" [ngClass]="acAmcStatus === 'Active' ? 'badge--green' : 'badge--grey'">
              {{ acAmcStatus }}
            </span>
          </div>
          <div class="summary-row">
            <span class="meta-label">Service Type</span>
            <span class="meta-value">{{ serviceType === 'Other' ? serviceTypeOther || 'Other' : serviceType }}</span>
          </div>
          <div class="summary-row" *ngIf="problemDescription">
            <span class="meta-label">Problem</span>
            <span class="meta-value">{{ problemDescription }}</span>
          </div>
          <div class="summary-row" *ngIf="preferredDate">
            <span class="meta-label">Preferred Date</span>
            <span class="meta-value">{{ formatDate(preferredDate) }}</span>
          </div>
          <div class="summary-row" *ngIf="preferredTimeSlot">
            <span class="meta-label">Time Slot</span>
            <span class="meta-value">{{ preferredTimeSlot }}</span>
          </div>
          <div class="summary-row summary-row--highlight">
            <span class="meta-label">Estimated Charges</span>
            <span class="meta-value" [ngClass]="isFreeService ? 'text-green' : 'text-bold'">
              {{ isFreeService ? 'Free (Covered)' : '$' + estimatedCharges }}
            </span>
          </div>
          <div class="summary-row">
            <span class="meta-label">Payment Required</span>
            <span class="meta-value">{{ !isFreeService && estimatedCharges > 0 ? 'Yes' : 'No' }}</span>
          </div>
        </div>

        <div *ngIf="error" class="error-msg">{{ error }}</div>

        <div class="step-footer">
          <button class="btn-ghost" (click)="prevStep()" [disabled]="submitting">Back</button>
          <button class="btn-primary" (click)="submit()" [disabled]="submitting">
            <span *ngIf="submitting" class="btn-spinner"></span>
            <span *ngIf="!submitting">Submit Request</span>
            <span *ngIf="submitting">Submitting...</span>
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
